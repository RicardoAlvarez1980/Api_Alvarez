<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>¡Chistes!</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Estilos personalizados -->
  <style>
    body {
      padding-top: 50px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="text-center mb-4">¡Chistes!</h1>
    <div id="chistesCarousel" class="carousel slide" data-bs-ride="carousel">
      <div class="carousel-inner" id="chistes"></div>
      <button class="carousel-control-prev" type="button" data-bs-target="#chistesCarousel" data-bs-slide="prev">
        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
        <span class="visually-hidden">Anterior</span>
      </button>
      <button class="carousel-control-next" type="button" data-bs-target="#chistesCarousel" data-bs-slide="next">
        <span class="carousel-control-next-icon" aria-hidden="true"></span>
        <span class="visually-hidden">Siguiente</span>
      </button>
    </div>
    <div class="text-center mt-3">
      <button class="btn btn-primary" type="button" id="nuevoChisteBtn">Nuevo Chiste</button>
    </div>
  </div>

  <!-- Bootstrap JS y jQuery (Necesarios para hacer la petición AJAX) -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    let chistesMostrados = [];

    document.getElementById('nuevoChisteBtn').addEventListener('click', function() {
      obtenerNuevoChiste();
    });

    // Función para mostrar el chiste
    function mostrarChiste(data) {
      let chiste = data.joke;
      let categoria = data.category;

      // Verificar si el chiste devuelto no es undefined
      if (chiste !== undefined) {
        // Verificar si el chiste ya ha sido mostrado
        if (!chistesMostrados.includes(chiste)) {
          chistesMostrados.push(chiste);

          let numeroChiste = chistesMostrados.length;
          let active = (numeroChiste === 1) ? 'active' : '';
          let nuevoChiste = `<div class="carousel-item ${active}" id="chiste-${numeroChiste}"><div class="card"><div class="card-body"><h5 class="card-title">Chiste #${numeroChiste}</h5><p class="card-text">${chiste}</p><p class="card-text"><strong>Categoría:</strong> ${categoria}</p><button class="btn btn-primary enviarBtn" data-chiste="${chiste}" data-categoria="${categoria}" data-numero="${numeroChiste}">Enviar</button> <button class="btn btn-danger eliminarBtn" data-numero="${numeroChiste}">Eliminar</button></div></div></div>`;
          document.getElementById('chistes').innerHTML += nuevoChiste;

          // Traducir chiste al español
          traducirChiste(chiste, numeroChiste);

          // Agregar evento click al botón de enviar
          $('.enviarBtn').click(function() {
            let numeroChiste = $(this).data('numero');
            let chiste = $(this).data('chiste');
            let categoria = $(this).data('categoria');
            let traduccion = $(`#chiste-${numeroChiste} .card-text`).eq(1).text().replace('Traducción al español:', '').trim();
            console.log("ID del Chiste:", numeroChiste);
            console.log("Chiste:", chiste);
            console.log("Traducción al español:", traduccion);
            console.log("Categoría:", categoria);
          });

          // Agregar evento click al botón de eliminar
          $('.eliminarBtn').click(function() {
            let numeroChiste = $(this).data('numero');
            eliminarChiste(numeroChiste);
          });
        } else {
          // Si el chiste ya ha sido mostrado, obtener otro chiste nuevo
          obtenerNuevoChiste();
        }
      } else {
        // Si el chiste devuelto es undefined, obtener otro chiste nuevo
        obtenerNuevoChiste();
      }
    }

    // Función para traducir el chiste al español
    function traducirChiste(chiste, numeroChiste) {
      fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=auto&tl=es&dt=t&q=${encodeURI(chiste)}`)
        .then(response => response.json())
        .then(data => mostrarTraduccion(data, numeroChiste))
        .catch(error => console.error('Error al traducir el chiste:', error));
    }

    // Función para mostrar la traducción del chiste
    function mostrarTraduccion(data, numeroChiste) {
      let traduccion = "";
      for (let i = 0; i < data[0].length; i++) {
        traduccion += data[0][i][0];
      }
      if (traduccion !== undefined) {
        $(`#chiste-${numeroChiste} .card-text`).eq(0).after(`<p class="card-text"><strong>Traducción al español:</strong> ${traduccion}</p>`);
      }
    }

    // Función para eliminar un chiste
    function eliminarChiste(numeroChiste) {
      $('#chiste-' + numeroChiste).remove();
      chistesMostrados.splice(numeroChiste - 1, 1);
    }

    // Función para obtener un nuevo chiste
    function obtenerNuevoChiste() {
      fetch('https://v2.jokeapi.dev/joke/Any')
        .then(response => response.json())
        .then(data => mostrarChiste(data))
        .catch(error => mostrarError(error));
    }

    // Función para mostrar el error
    function mostrarError(error) {
      document.getElementById('chistes').innerHTML += `<div class="col-md-6 offset-md-3 mb-3"><div class="alert alert-danger" role="alert">Ocurrió un error al obtener el chiste. Por favor, inténtalo de nuevo más tarde.</div></div>`;
    }
  </script>
</body>
</html>
